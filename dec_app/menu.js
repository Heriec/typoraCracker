var menuDict,electron=require("electron"),app=electron.app,dialog=electron.dialog,Menu=electron.Menu,MenuItem=electron.MenuItem,BrowserWindow=electron.BrowserWindow,ipc=electron.ipcMain,fs=require("fs-extra"),isWin="win32"==process.platform,isMac="darwin"==process.platform,isLinux="linux"==process.platform,License=require("License.js"),t_workingDir=require("path").join(__dirname,"../");ipc.on("execForAll",function(e,t){execForAll(t)}),ipc.on("forceRefreshMenu",function(e,t){app.forceRefreshMenu()}),ipc.on("syncToPreference",function(e,t){electron.webContents.getAllWebContents().forEach(function(e){e.send("syncToPreference",t)})}),exports.loadDict=(()=>{if(menuDict)return Promise.resolve(menuDict);var e=app.setting.getUserLocale(),t=require("path").join(t_workingDir,app.setting.getLocaleFolder("Menu"));return new Promise(l=>{fs.readFile(t,"utf8",(t,n)=>{menuDict=n?JSON.parse(n):{},l(menuDict),t&&console.warn("cannot load dict as ["+e+"] "+t.stack)})})});var refreshMenu=function(){updateRecentFilesInMenu(Menu.getApplicationMenu())},execForAll=function(e){var t=e=e.toString();/^\s*function\s*\(/.exec(e)&&(t="window.File && ("+e+")();"),app.execInAll(t),console.log(t)},performClientCommand=function(e,t){var l=BrowserWindow.getFocusedWindow();l&&(t?l.webContents.executeJavaScript("window.File && !File.blockUI && ("+e.toString()+")();window.Reporter && window.Reporter.fullValidate();"):l.webContents.executeJavaScript("!File.blockUI && window.ClientCommand['"+e+"']();window.Reporter && window.Reporter.fullValidate();"))},getClientCommand=function(e,t){return function(){performClientCommand(e,t)}};function getLocalizedLabel(e){var t=/&[a-z]/i.exec(e),l=/(\.\.\.)|(…)/.exec(e);e=e.replace(/(\.\.\.)|(…)|&/g,"");var n=(menuDict||{})[e]||e;return t?putAccelerator(e,n)+(l?"…":""):n+(l?"…":"")}function getIgnoreCase(e,t){if(t){if(!e._useLowerCase){for(var l in e)e[l.toLowerCase().replace(/[.…]/g,"")]=e[l];e._useLowerCase=!0}return e[t.toLowerCase()]}}var MenuItemsWithAccelerator={File:"F",Edit:"E",Paragraph:"P",Format:"O",View:"V",Themes:"T",Help:"H"};function putAccelerator(e,t){var l=MenuItemsWithAccelerator[e];if(!l)return t;if(isWin||isLinux){var n=t.indexOf(l);if(-1==n)n=t.indexOf(l.toLowerCase());else{var i=t.indexOf(l.toLowerCase());i>-1&&(n=Math.min(n,i))}n>-1?t=t.substr(0,n)+"&"+t.substr(n):t+=isWin?"(​&"+l+")":"(&"+l+")"}return t}function processMenu(e){if(!e||!e.label)return e;var t=e.label;if(e.label=getLocalizedLabel(e.label),e.submenu)e.submenu.forEach(processMenu);else{var l=app.setting.config.keyBinding||{},n=getIgnoreCase(l,(e.label||"").replace(/[.…]/g,""));if(void 0===n&&(n=getIgnoreCase(l,(t||"").replace(/[.…]/g,""))),void 0!==n&&(e.accelerator=n+""),(e.accelerator||"").startsWith("global:")){e.accelerator=e.accelerator.substr("global:".length);var i=e.click;i&&electron.globalShortcut.register(e.accelerator,()=>{setTimeout(i,0)})}}return e}var getKeyAccelerator=function(e,t){var l={label:e,accelerator:t};return processMenu(l),l.accelerator};function updateRecentFilesInMenu(e){function t(e,t){var l=e.label;fs.existsSync(l)?app.openFileOrFolder(l,{curWindow:t}):(dialog.showMessageBox({title:getLocalizedLabel("Open Failed"),message:getLocalizedLabel("File or folder does not exist."),buttons:["Close"],cancelId:0,defaultId:0}),app.setting.removeRecentDocument(l))}try{var l=e.getItem("File").submenu.getItem("Open Recent").submenu,n=app.setting.getRecentDocuments(),i=app.setting.getRecentFolders();n.sort(function(e,t){return t.date-e.date}),i.sort(function(e,t){return t.date-e.date}),l.clear(),l.append(new MenuItem({label:getLocalizedLabel("Reopen Closed File"),accelerator:"CmdOrCtrl+Shift+T",click:function(){app.reopenClosed()}})),l.append(new MenuItem({type:"separator"})),n.length&&(n.forEach(function(e,n){n>10||l.append(new MenuItem({label:e.path,click:t}))}),l.append(new MenuItem({type:"separator"}))),i.length&&(i.forEach(function(e,n){n>8||l.append(new MenuItem({label:e.path,click:t}))}),l.append(new MenuItem({type:"separator"}))),n.length+i.length?l.append(new MenuItem(processMenu({label:"Clear Items",click:function(){app.setting.clearRecentDocuments()},type:"normal"}))):l.append(new MenuItem(processMenu({label:"No Recent Files",enabled:!1}))),Menu.setApplicationMenu(e)}catch(e){}}function bindMainMenu(){function e(e,t){var l=(/\((.+)\)/.exec(e.label)||[])[1]||e.label;l==getLocalizedLabel("Auto")&&(l=""),performClientCommand("function(){File.reloadWithEncoding('"+l+"')}",!0)}var t=app.setting.get("SmartyPantsOnRendering")||!1,l=app.setting.get("smartQuote")||!1,n=app.setting.get("smartDash")||!1,i=[processMenu({label:"&File",submenu:[{label:"New",accelerator:"CmdOrCtrl+N",click:getClientCommand("newFile")},{label:"New Window",accelerator:"CmdOrCtrl+Shift+N",click:getClientCommand("newWindow")},{type:"separator"},{label:"Open…",accelerator:"CmdOrCtrl+O",click:getClientCommand("open")},{label:"Open Folder…",click:getClientCommand("openFolder")},{type:"separator"},{label:"Open Quickly…",accelerator:"CmdOrCtrl+P",click:getClientCommand("quickOpen")},{label:"Open Recent",submenu:[]},{label:"Reopen with Encoding",submenu:[{label:"Auto",click:e},{type:"separator"},{label:"UTF-8",click:e},{label:"UTF-16 LE",click:e},{label:"UTF-16 BE",click:e},{type:"separator"},{label:"Western (windows-1252)",click:e},{label:"Cyrillic (windows-1251)",click:e},{label:"Cyrillic (ISO-8859-2)",click:e},{label:"Cyrillic (IBM866)",click:e},{label:"Cyrillic (IBM855)",click:e},{label:"Cyrillic (KOI8-R)",click:e},{label:"Cyrillic (MacCyrillic)",click:e},{label:"Central European (windows-1250)",click:e},{label:"Central European (ISO-8859-2)",click:e},{label:"Geek (windows-1253)",click:e},{label:"Geek (ISO-8859-7)",click:e},{label:"Hebrew (windows-1255)",click:e},{label:"Hebrew (ISO-8859-8)",click:e},{label:"Chinese Simplified (GB2312)",click:e},{label:"Chinese Simplified (GB18030)",click:e},{label:"Chinese Traditional (Big5)",click:e},{label:"Japanese (SHIFT_JIS)",click:e},{label:"Japanese (EUC-JP)",click:e},{label:"Korean (EUC-KR)",click:e},{label:"Thai (TIS-620)",click:e}]},{type:"separator"},{label:"Save",accelerator:"CmdOrCtrl+S",click:getClientCommand("save")},{label:"Save As…",accelerator:"CmdOrCtrl+Shift+S",click:getClientCommand("saveAs")},{label:"Save All…",click:getClientCommand("saveAll")},{type:"separator"},isLinux?null:{label:"Properties…",click:function(e,t){t&&t.webContents.executeJavaScript('reqnode("win-shell").openProperties(File.filePath);')}},{label:"Open File Location…",click:getClientCommand("openFileLocation")},{label:"Reveal in Sidebar",click:getClientCommand(function(){window.File.editor.library.revealInSidebar()},!0)},{label:"Delete…",click:function(e,t){t&&t.webContents.executeJavaScript("File.trashSelf();")}},{type:"separator"},{label:"Import…",click:getClientCommand("import")},{label:"Export",submenu:loadExport()},{label:"Print…",accelerator:"Shift+Alt+P",click:getClientCommand("print")},{type:"separator"},{label:"Preferences…",accelerator:"CmdOrCtrl+,",click:getClientCommand("togglePreferencePanel")},{type:"separator"},{label:"Close",accelerator:"CmdOrCtrl+W",click:getClientCommand("close")}]}),processMenu({label:"&Edit",id:"edit",submenu:[{label:"Undo",id:"undo",accelerator:"CmdOrCtrl+Z",click:getClientCommand("undo")},{label:"Redo",id:"redo",accelerator:"CmdOrCtrl+Y",click:getClientCommand("redo")},{type:"separator"},{label:"Cut",accelerator:"CmdOrCtrl+X",role:"cut"},{label:"Copy",accelerator:"CmdOrCtrl+C",role:"copy"},{label:"Copy Image",click:function(e,t){t&&t.webContents.executeJavaScript("File.editor.imgEdit.copyImage()")}},{label:"Paste",accelerator:"CmdOrCtrl+V",role:"paste"},{type:"separator"},{label:"Copy as Plain Text",click:getClientCommand("copyAsPlainText")},{label:"Copy as Markdown",accelerator:"CmdOrCtrl+Shift+C",click:getClientCommand("copyAsMarkdown")},{label:"Copy as HTML Code",click:getClientCommand("copyAsHTMLSource")},{label:"Copy without Theme Styling",click:getClientCommand("copyAsSemanticHTML")},{type:"separator"},{label:"Paste as Plain Text",accelerator:"CmdOrCtrl+Shift+v",click:getClientCommand("pasteAsPlain")},{type:"separator"},{label:"Selection",submenu:[{label:"Select All",accelerator:"CmdOrCtrl+A",click:getClientCommand("selectAll")},{label:"Select Line/Sentence",accelerator:"CmdOrCtrl+L",click:getClientCommand(function(){File.editor.selection.selectLine()},!0)},{label:"Select Styled Scope",accelerator:"CmdOrCtrl+E",click:getClientCommand(function(){File.editor.selection.selectPhrase()},!0)},{label:"Select Word",accelerator:"CmdOrCtrl+D",click:getClientCommand(function(){File.editor.selection.selectWord()},!0)},{type:"separator"},{label:"Jump to Top",accelerator:"Ctrl+Home",click:getClientCommand(function(){File.editor.selection.jumpTop()},!0)},{label:"Jump to Selection",accelerator:"CmdOrCtrl+j",click:getClientCommand(function(){File.editor.selection.jumpSelection()},!0)},{label:"Jump to Bottom",accelerator:"Ctrl+End",click:getClientCommand(function(){File.editor.selection.jumpBottom()},!0)},{label:"Extend Selection to Top",accelerator:"Ctrl+Shift+Home",visible:!1,click:getClientCommand(function(){File.editor.selection.jumpTop(!0)},!0)},{label:"Extend Selection to Bottom",accelerator:"Ctrl+Shift+End",visible:!1,click:getClientCommand(function(){File.editor.selection.jumpBottom(!0)},!0)},{label:"Extend Selection to Line Start",accelerator:"Shift+Home",visible:!1,click:getClientCommand(function(){File.editor.selection.extendToLineEdge(!1)},!0)},{label:"Extend Selection to Line End",accelerator:"Shift+End",visible:!1,click:getClientCommand(function(){File.editor.selection.extendToLineEdge(!0)},!0)}]},{type:"separator"},{label:"Delete",click:getClientCommand(function(){File.delete()},!0)},{label:"Delete Range",submenu:[{label:"Delete Word",accelerator:"Shift+Ctrl+D",click:getClientCommand("deleteWord")},{label:"Delete Styled Scope",click:getClientCommand("deleteScope")},{label:"Delete Line/Sentence",click:getClientCommand("deleteLine")},{label:"Delete Block",click:getClientCommand("deleteBlock")}]},{type:"separator"},{label:"Math Tools",submenu:[{label:"Refresh All Math Expressions",click:getClientCommand(function(){File.editor.mathBlock.forceRefresh()},!0)}]},{type:"separator"},{label:"Smart Punctuation",submenu:[{label:"Convert on Input",type:"checkbox",click:function(e,t){if(t){var l=e.checked;t.webContents.executeJavaScript("File.megaMenu.setSmartyPantsTiming("+!l+")")}},checked:!t},{label:"Convert on Rendering",type:"checkbox",click:function(e,t){if(t){var l=e.checked;t.webContents.executeJavaScript("File.megaMenu.setSmartyPantsTiming("+l+")")}},checked:t},{type:"separator"},{label:"Smart Quotes",type:"checkbox",click:function(e,t){if(t){var l=e.checked;t.webContents.executeJavaScript("File.megaMenu.setSmartQuote("+l+")")}},checked:l},{label:"Smart Dashes",type:"checkbox",click:function(e,t){if(t){var l=e.checked;t.webContents.executeJavaScript("File.megaMenu.setSmartDash("+l+")")}},checked:n},{type:"separator"},{label:"Remap Unicode Punctuation on Parse",type:"checkbox",click:function(e,t){if(t){var l=e.checked;t.webContents.executeJavaScript("File.megaMenu.setRemapPunctuation("+l+")")}},checked:app.setting.get("remapPunctuation")||!t&&(l||n),enabled:!(!t&&(l||n))},{type:"separator"},{label:"More Options…",click:function(e,t){t&&t.webContents.executeJavaScript("File.megaMenu.highlight('smart-punctuation-group');")}}]},{label:"Line Endings",submenu:[{label:"Windows Line Endings (CRLF)",type:"checkbox",click:getClientCommand(function(){File.setLineEnding(!0,!0)},!0)},{label:"Unix Line Endings (LF)",type:"checkbox",click:getClientCommand(function(){File.setLineEnding(!1,!0)},!0)},{type:"separator"},{label:"Insert Final New Line On Save",type:"checkbox",click:function(e,t){t&&t.webContents.executeJavaScript("File.setFinalNewline("+e.checked+")")}}]},{label:"Whitespace and Line Breaks",submenu:[{label:"Indent first line of paragraphs",type:"checkbox",click:getClientCommand(function(){File.setIndentFirstLine(!File.option.indentFirstLine,!0,!0)},!0)},{type:"separator"},{label:"Visible <br/>",type:"checkbox",checked:!0,click:getClientCommand(function(){File.setHideBrAndLineBreak(!File.option.hideBrAndLineBreak,!0,!0)},!0)},{label:"Preserve single line break",type:"checkbox",checked:!0,click:getClientCommand(function(){File.setIgnoreLineBreak(!File.option.ignoreLineBreak,!0,!0)},!0)},{type:"separator"},{label:"Learn More…",click:function(){electron.shell.openExternal("https://support.typora.io/Line-Break/")}}]},{label:"Spell Check…",click:function(e,t){t&&t.webContents.executeJavaScript("File.editor.spellChecker && File.editor.spellChecker.show();")}},{type:"separator"},{label:"Find and Replace",submenu:[{label:"Find…",accelerator:"CmdOrCtrl+f",click:getClientCommand(function(){File.megaMenu.isPreferencePanelShown()?File.megaMenu.searchOnPreferencePanel():File.editor.searchPanel.showPanel()},!0)},{label:"Find Next",accelerator:"F3",click:getClientCommand(function(){File.editor.searchPanel.highlightNext()},!0)},{label:"Find Previous",accelerator:"Shift+F3",click:getClientCommand(function(){File.editor.searchPanel.highlightNext(!0)},!0)},{type:"separator"},{label:"Replace",accelerator:"Ctrl+h",click:getClientCommand(function(){File.editor.searchPanel.showPanel(!0)},!0)}]}]}),processMenu({label:"&Paragraph",submenu:[{label:"Heading 1",type:"checkbox",accelerator:"Ctrl+1",click:getClientCommand(function(){File.editor.stylize.changeBlock("header1",void 0,!0)},!0)},{label:"Heading 2",type:"checkbox",accelerator:"Ctrl+2",click:getClientCommand(function(){File.editor.stylize.changeBlock("header2",void 0,!0)},!0)},{label:"Heading 3",type:"checkbox",accelerator:"Ctrl+3",click:getClientCommand(function(){File.editor.stylize.changeBlock("header3",void 0,!0)},!0)},{label:"Heading 4",type:"checkbox",accelerator:"Ctrl+4",click:getClientCommand(function(){File.editor.stylize.changeBlock("header4",void 0,!0)},!0)},{label:"Heading 5",type:"checkbox",accelerator:"Ctrl+5",click:getClientCommand(function(){File.editor.stylize.changeBlock("header5",void 0,!0)},!0)},{label:"Heading 6",type:"checkbox",accelerator:"Ctrl+6",click:getClientCommand(function(){File.editor.stylize.changeBlock("header6",void 0,!0)},!0)},{type:"separator"},{label:"Paragraph",type:"checkbox",accelerator:"Ctrl+0",click:getClientCommand(function(){File.editor.stylize.changeBlock("paragraph")},!0)},{type:"separator"},{label:"Increase Heading Level",accelerator:"Ctrl+=",click:getClientCommand(function(){File.editor.stylize.increaseHeaderLevel()},!0)},{label:"Decrease Heading Level",accelerator:"Ctrl+-",click:getClientCommand(function(){File.editor.stylize.decreaseHeaderLevel()},!0)},{type:"separator"},{label:"Table",submenu:[{label:"Insert Table",accelerator:"Ctrl+T",click:getClientCommand(function(){File.editor.tableEdit.insertTable()},!0)},{type:"separator"},{label:"Add Row Above",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.addRow(!0)},!0)},{label:"Add Row Below",accelerator:"Ctrl+Return",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.addRow(!1)},!0)},{type:"separator"},{label:"Add Column Before",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.addCol(!1)},!0)},{label:"Add Column After",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.addCol(!1)},!0)},{type:"separator"},{label:"Move Row Up",enabled:!1,accelerator:"Alt+Up",click:getClientCommand(function(){File.editor.tableEdit.moveRowUpOrDown(!0)},!0)},{label:"Move Row Down",enabled:!1,accelerator:"Alt+Down",click:getClientCommand(function(){File.editor.tableEdit.moveRowUpOrDown(!1)},!0)},{label:"Move Column Left",enabled:!1,accelerator:"Alt+Left",click:getClientCommand(function(){File.editor.tableEdit.moveColLeftOrRight(!0)},!0)},{label:"Move Column Right",enabled:!1,accelerator:"Alt+Right",click:getClientCommand(function(){File.editor.tableEdit.moveColLeftOrRight(!1)},!0)},{type:"separator"},{label:"Delete Row",enabled:!1,accelerator:"Shift+Ctrl+Backspace",click:getClientCommand(function(){File.editor.tableEdit.deleteRow()},!0)},{label:"Delete Column",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.deleteCol()},!0)},{type:"separator"},{label:"Copy Table",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.copyTable()},!0)},{label:"Prettify Source Code",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.reformatTable()},!0)},{type:"separator"},{label:"Delete Table",enabled:!1,click:getClientCommand(function(){File.editor.tableEdit.deleteTable()},!0)}]},{label:"Code Fences",type:"checkbox",accelerator:"Ctrl+Shift+K",click:getClientCommand(function(){File.editor.stylize.toggleFences()},!0)},{label:"Math Block",type:"checkbox",accelerator:"Ctrl+Shift+M",click:getClientCommand(function(){File.editor.stylize.toggleMathBlock()},!0)},{type:"separator"},{label:"Quote",type:"checkbox",accelerator:"Ctrl+Shift+Q",click:getClientCommand(function(){File.editor.stylize.toggleIndent("blockquote")},!0)},{type:"separator"},{label:"Ordered List",type:"checkbox",accelerator:"Ctrl+Shift+[",click:getClientCommand(function(){File.editor.stylize.toggleIndent("ol")},!0)},{label:"Unordered List",type:"checkbox",accelerator:"Ctrl+Shift+]",click:getClientCommand(function(){File.editor.stylize.toggleIndent("ul")},!0)},{label:"Task List",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleIndent("tasklist")},!0)},{label:"Task Status",submenu:[{label:"Toggle Task Status",click:getClientCommand(function(){File.editor.stylize.toggleTaskStatus()},!0)},{type:"separator"},{label:"Mark as Complete",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleTaskStatus(!0)},!0)},{label:"Mark as Incomplete",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleTaskStatus(!1)},!0)}]},{label:"List Indentation",submenu:[{label:"Indent",accelerator:"CmdOrCtrl+]",click:getClientCommand(function(){File.editor.UserOp.moreIndent(File.editor)},!0)},{label:"Outdent",accelerator:"CmdOrCtrl+[",click:getClientCommand(function(){File.editor.UserOp.lessIndent(File.editor)},!0)}]},{type:"separator"},{label:"Insert Paragraph Before",click:getClientCommand(function(){File.editor.UserOp.insertParagraph(!0)},!0)},{label:"Insert Paragraph After",click:getClientCommand(function(){File.editor.UserOp.insertParagraph(!1)},!0)},{type:"separator"},{label:"Link Reference",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.insertBlock("def_link")},!0)},{label:"Footnotes",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.insertBlock("def_footnote")},!0)},{type:"separator"},{label:"Horizontal Line",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.insertBlock("hr")},!0)},{label:"Table of Contents",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.insertBlock("toc")},!0)},{label:"YAML Front Matter",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.insertMetaBlock()},!0)}]}),processMenu({label:"F&ormat",submenu:[{label:"Strong",type:"checkbox",accelerator:"CmdOrCtrl+B",click:getClientCommand(function(){File.editor.stylize.toggleStyle("strong")},!0)},{label:"Emphasis",type:"checkbox",accelerator:"CmdOrCtrl+I",click:getClientCommand(function(){File.editor.stylize.toggleStyle("em")},!0)},{label:"Underline",type:"checkbox",accelerator:"CmdOrCtrl+U",click:getClientCommand(function(){File.editor.stylize.toggleStyle("underline")},!0)},{label:"Code",type:"checkbox",accelerator:"CmdOrCtrl+Shift+`",click:getClientCommand(function(){File.editor.stylize.toggleStyle("code")},!0)},{type:"separator"},{label:"Inline Math",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleStyle("inline_math")},!0)},{label:"Strike",type:"checkbox",accelerator:"Alt+Shift+5",click:getClientCommand(function(){File.editor.stylize.toggleStyle("del")},!0)},{label:"Highlight",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleStyle("highlight")},!0)},{label:"Superscript",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleStyle("superscript")},!0)},{label:"Subscript",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleStyle("subscript")},!0)},{label:"Comment",type:"checkbox",click:getClientCommand(function(){File.editor.stylize.toggleStyle("comment")},!0)},{type:"separator"},{label:"Hyperlink",type:"checkbox",accelerator:"Ctrl+K",click:getClientCommand(function(){File.editor.stylize.toggleStyle("link")},!0)},{label:"Hyperlink Actions",submenu:[{label:"Open Link",click:getClientCommand(function(){File.editor.openCurrentLink()},!0)},{label:"Copy Link Address",click:getClientCommand(function(){File.editor.copyCurrentLink()},!0)}]},{label:"Image",submenu:[{label:"Insert Image",accelerator:"CmdOrCtrl+Shift+I",click:getClientCommand(function(){File.editor.stylize.toggleStyle("image")},!0)},{label:"Insert Local Images…",click:getClientCommand(function(){File.editor.imgEdit.insertLocalImage()},!0)},{type:"separator"},{label:"Copy Image",click:function(e,t){t&&t.webContents.executeJavaScript("File.editor.imgEdit.copyImage()")}},{label:"Open Image Location…",click:getClientCommand(function(){File.editor.imgEdit.revealInFinder()},!0)},{label:"Copy Image to…",click:getClientCommand(function(){File.editor.imgEdit.copyToSelectedFolderAction()},!0)},{label:"Upload Image",click:getClientCommand(function(){File.editor.imgEdit.uploadAction()},!0)},{label:"Zoom Image",submenu:[{label:"25%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"25%")},!0)},{label:"33%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"33%")},!0)},{label:"50%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"50%")},!0)},{label:"67%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"67%")},!0)},{label:"80%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"80%")},!0)},{type:"separator"},{label:"100%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"100%")},!0)},{type:"separator"},{label:"150%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"150%")},!0)},{label:"200%",click:getClientCommand(function(){File.editor.imgEdit.zoomAction(null,"200%")},!0)}]},{type:"separator"},{label:"Upload All Local Images",click:getClientCommand(function(){File.editor.imgEdit.uploadAllImages()},!0)},{label:"When Insert Local Image",submenu:[{label:"Copy Image File to Folder…",type:"checkbox",click:getClientCommand(function(){File.editor.imgEdit.toggleCopyToFolder()},!0)},{label:"Upload Image",type:"checkbox",click:getClientCommand(function(){File.editor.imgEdit.toggleUploadForFile()},!0)}]},{label:"Use Image Root Path…",type:"checkbox",click:getClientCommand(function(){File.editor.imgEdit.toggleUseImageRootPath()},!0)},{type:"separator"},{label:"Global Image Settings…",click:function(e,t){t&&t.webContents.executeJavaScript("File.megaMenu.highlight('image-setting-group');")}}]},{type:"separator"},{label:"Clear Format",type:"checkbox",accelerator:"CmdOrCtrl+\\",click:getClientCommand(function(){File.editor.stylize.clearStyle()},!0)}]}),processMenu({label:"&View",submenu:[{label:"Toggle Sidebar",accelerator:"CmdOrCtrl+Shift+L",click:getClientCommand(function(){File.editor.library.toggleSidebar()},!0)},{label:"Outline",type:"checkbox",accelerator:"CmdOrCtrl+Shift+1",click:getClientCommand("toggleOutline")},{label:"Articles",type:"checkbox",accelerator:"CmdOrCtrl+Shift+2",click:getClientCommand("toggleFileList")},{label:"File Tree",type:"checkbox",accelerator:"CmdOrCtrl+Shift+3",click:getClientCommand("toggleFileTree")},{label:"Search",type:"checkbox",accelerator:"CmdOrCtrl+Shift+F",click:getClientCommand("globalSearch")},{type:"separator"},{label:"Source Code Mode",type:"checkbox",accelerator:"CmdOrCtrl+/",click:getClientCommand(function(){File.toggleSourceMode()},!0)},{type:"separator"},{label:"Focus Mode",type:"checkbox",accelerator:"F8",click:getClientCommand(function(){File.editor.toggleFocusMode()},!0),enabled:!1},{label:"Typewriter Mode",type:"checkbox",accelerator:"F9",click:getClientCommand(function(){File.editor.toggleTypeWriterMode()},!0),enabled:!1},{type:"separator"},{label:"Show Status Bar",type:"checkbox",click:getClientCommand("toggleStatusBar")},{type:"separator"},{label:"Toggle Fullscreen",accelerator:"F11",click:function(e,t){t&&(t.isFullScreen()?t.setFullScreen(!1):t.setFullScreen(!0))}},{label:"Always on Top",type:"checkbox",click:function(e,t){t&&(performClientCommand(function(){document.body.classList.toggle("always-on-top")},!0),t.setAlwaysOnTop(!t.isAlwaysOnTop()),e.checked=t.isAlwaysOnTop())}},{type:"separator"},{label:"Actual Size",type:"checkbox",accelerator:isWin?"Ctrl+Shift+9":"Ctrl+Shift+0",click:function(e,t){execForAll(function(){ClientCommand.resetZoom()}),performClientCommand(function(){ClientCommand.refreshViewMenu()},!0)}},{label:"Zoom In",accelerator:"Ctrl+Shift+=",click:function(e,t){execForAll(function(){ClientCommand.zoomIn()}),performClientCommand(function(){ClientCommand.refreshViewMenu()},!0)}},{label:"Zoom Out",accelerator:"Ctrl+Shift+-",click:function(e,t){execForAll(function(){ClientCommand.zoomOut()}),performClientCommand(function(){ClientCommand.refreshViewMenu()},!0)}},{type:"separator"},{label:"Switch Between Opened Documents",accelerator:"Ctrl+Tab",click:function(e,t){if(t){var l=BrowserWindow.getAllWindows(),n=l.indexOf(t);-1!=n&&l[n=++n>=l.length?0:n].focus()}}},{type:"separator"},{label:"Toggle DevTools",accelerator:"Shift+F12",click:function(e,t){if(t){var l=setTimeout(t.webContents.openDevTools,2e3);t.webContents.executeJavaScript("ClientCommand.toggleDevTools()").then(function(){clearTimeout(l)},function(){clearTimeout(l),t.webContents.openDevTools()})}}}]}),processMenu({label:"&Themes",submenu:[]}),processMenu({label:"&Help",submenu:[{label:"What's New…",click:function(){electron.shell.openExternal("https://support.typora.io/What's-New/")}},{type:"separator"},{label:"Quick Start",click:function(e,t){app.openFile(t_workingDir+"/Docs/Quick Start.md")}},{label:"Markdown Reference",click:function(e,t){app.openFile(t_workingDir+"/Docs/Markdown Reference.md")}},{label:"Install and Use Pandoc",click:function(e,t){app.openFile(t_workingDir+"/Docs/Install and Use Pandoc.md")}},{label:"Custom Themes",click:function(e,t){app.openFile(t_workingDir+"/Docs/Custom Themes.md")}},{label:"Use Images in Typora",click:function(e,t){app.openFile(t_workingDir+"/Docs/Use Images in Typora.md")}},{label:"Data Recovery and Version Control",click:function(e,t){app.openFile(t_workingDir+"/Docs/Auto Save, Version Control and Recovery.md")}},{label:"More Topics…",click:function(e,t){electron.shell.openExternal("https://support.typora.io")}},{type:"separator"},{label:"Credits",click:function(e,t){app.openFile(t_workingDir+"/Docs/Credits.md")}},{label:"Change Log",click:function(e,t){app.openFile(t_workingDir+"/Docs/Change Log.md")}},{label:"Privacy Policy",click:function(e,t){app.openFile(t_workingDir+"/Docs/Privacy Policy.md")}},{label:"Website",click:function(){electron.shell.openExternal("http://typora.io")}},{label:"Feedback",click:function(e,t){electron.shell.openExternal("mailto:hi@typora.io")}},{type:"separator"},{label:"Check Updates…",click:function(){isWin&&app.updater.checkForUpdates(!0)},visible:isWin},global.PRODUCTION_MODE&&global.betaVersion?null:{label:"My License…",click:function(){License.showLicensePanel()}},isLinux||global.PRODUCTION_MODE?null:{label:"Welcome…",click:function(){License.showWelcomePanel()}},{label:"About",click:getClientCommand(function(){File.megaMenu.closePreferencePanel(),document.body.classList.contains("native-window")?($(".modal:not(.block-modal)").modal("hide"),$("#about-dialog").modal("show"),$("*:focus").blur()):(File.megaMenu.show(),$("#m-about").trigger("click"))},!0)}]})];isLinux&&i[0].submenu.splice(i[0].submenu.indexOf(null),1),app.isEmojiPanelSupported()&&(i[1].submenu.push({type:"separator"}),i[1].submenu.push(processMenu({label:"Emoji and Symbols",accelerator:isWin?"Super+.":"",click:function(){app.showEmojiPanel()}})));const o=i[i.length-1].submenu;for(;o.indexOf(null)>-1;)o.splice(o.indexOf(null),1);var a=Menu.buildFromTemplate(i);updateRecentFilesInMenu(a),Menu.setApplicationMenu(a),(app.setting.getAllThemes()||[]).length>0&&app.setting.refreshThemeMenu()}exports.getKeyAccelerator=getKeyAccelerator,Menu.prototype.getItem=function(e){if(!e)return null;for(var t=this.getItemCount(),l=0;l<t;l++){var n=this.items[l].label.replace(/\(\u200b*&[A-Z]\)/,"").replace(/[&\.…]/g,"");if(n==(e=e.replace(/[&\.…]/g,""))||n==getLocalizedLabel(e))return this.items[l]}return null},MenuItem.prototype.setEnabled=function(e){this.enabled=e},MenuItem.prototype.setHidden=function(e){this.visible=!e},MenuItem.prototype.setState=function(e){this.checked=e};var cachedMenuItems_,loadExport=function(e){var t=[],l=function(e){var t=e;return"string"==typeof e&&(t={key:e,type:e}),function(e,l){!function(e,t){if(t){var l=Object.assign({},app.setting.exportSettingFor(e.key),e);t.webContents.send("export",l)}}(t,l)}};t.push({label:"PDF",click:l("pdf")}),t.push({label:"HTML",click:l("html")}),t.push({label:"HTML (without styles)",click:l("html-plain")}),t.push({label:"Image",click:l("image")});var n=app.setting.loadCustomExports();if(n.length&&t.push({type:"separator"}),n.forEach(e=>{e.type&&(hasCustom=!0,t.push({label:e.name,click:l(e)}))}),t.push({type:"separator"}),t.push({label:"Export with Previous",accelerator:"Shift+CmdOrCtrl+E",click:function(e,t){t&&t.webContents.executeJavaScript("ClientCommand && ClientCommand.exportLast();")},enabled:!!app.setting.lastExport}),t.push({label:"Export and Overwrite with Previous",click:function(e,t){t&&t.webContents.executeJavaScript("ClientCommand && ClientCommand.exportLast(true)")},enabled:!!app.setting.lastExport}),t.push({type:"separator"}),t.push({label:"Export Setting…",click:function(e,t){t&&t.webContents.executeJavaScript("File.megaMenu.highlight('export-setting-group');")},enabled:!0}),e){t.forEach(processMenu);var i=getMenuItem("File→Export").submenu;t[t.length-1].enabled=(getMenuItemUnder("Export and Overwrite with Previous",i)||{}).enabled,i.clear(),t.forEach(e=>{i.append(new MenuItem(e))}),isMac&&Menu.setApplicationMenu(Menu.getApplicationMenu())}return t},forceRefreshThrottle=null;app.forceRefreshMenu=function(){isLinux&&(forceRefreshThrottle&&clearTimeout(forceRefreshThrottle),forceRefreshThrottle=setTimeout(function(){Menu.setApplicationMenu(Menu.getApplicationMenu()),forceRefreshThrottle=null},100))};var getMenuItem=function(e){if(!e)return null;var t,l=(cachedMenuItems_=cachedMenuItems_||{})[e];return l||(e.split("→").forEach(function(e){if(l=getMenuItemUnder(e,l),cachedMenuItems_[t=t?t+"→"+e:e]=l,!l)return null}),cachedMenuItems_=null,l)},getMenuItemUnder=function(e,t){var l=t?t.submenu:Menu.getApplicationMenu();if(l){var n=l.getItem(e);return t||n||"File"!=e||(n=l.getItem("Typora")||l.getItem("Electron")),n}return null};app.updateMenu=function(e){function t(e,t){t.enabled||t.state?(e.enabled=!0,e.submenu.items.forEach(function(e,l){e.enabled=0==l?!t.state:t.state})):e.enabled=!1}cachedMenuItems_={};for(var l in e){var n=getMenuItem(l),i=e[l];if(n){var o=null;if(void 0!==i.accelerator){i.accelerator;var a=getKeyAccelerator(n.label,i.accelerator);a!=n.accelerator&&(o=new MenuItem(processMenu({label:n.label,type:n.type,enabled:n.enabled,checked:n.enabled,click:n.click,accelerator:a}))),n=o}if("Paragraph→Table"!=l){if(void 0!==i.state&&(n.checked=i.state),void 0!==i.enabled&&(n.enabled=i.enabled,"Paragraph"!=l&&"Format"!=l&&"Format→Image→Zoom Image"!=l||n.submenu.items.forEach(function(e){e.enabled=i.enabled})),void 0!==i.hidden&&(n.visible=!i.hidden),o){var c=getMenuItem(l.replace(/→[^→]+$/,"")).submenu.items,r=c.findIndex(e=>e.label==o.label);r>-1&&(c.splice(r,1,o),console.log("newItem.accelerator "+o.accelerator))}}else t(n,i),!0}}cachedMenuItems_=null,app.forceRefreshMenu()},ipc.on("menu.updateMenu",function(e,t){app.updateMenu(JSON.parse(t))}),ipc.handle("menu.updateCustomZoom",e=>{app.updateMenu({"View→Actual Size":{state:!app.setting.get("customZoom")}})}),ipc.handle("menu.refreshThemeMenu",function(e){app.setting.refreshThemeMenu()}),ipc.handle("menu.reloadExportMenu",function(e){loadExport(!0)}),ipc.handle("menu.popup",function(e,t){Menu.getApplicationMenu().popup(t)}),exports.bindMainMenu=bindMainMenu,exports.refreshMenu=refreshMenu,exports.getMenuDict=function(){return menuDict||{}};